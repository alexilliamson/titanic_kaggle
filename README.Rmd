---
title: "Titanic"
output: 
  html_document: 
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(caret)
```


### Data  

```{r}
labeled_df <- read_csv('data/train.csv', col_types = cols(
        PassengerId = col_integer(),
        Survived = col_factor(levels = c(0,1)),
        Pclass = col_factor(levels = NULL),
        Name = col_character(),
        Sex = col_factor(levels = NULL),
        Age = col_double(),
        SibSp = col_factor(levels = NULL),
        Parch = col_factor(levels = NULL),
        Ticket = col_character(),
        Fare = col_double(),
        Cabin = col_character(),
        Embarked = col_character())
) %>%
        mutate(Survived = fct_recode(Survived, survive = '1', no_survive = '0'))

submission_df <- read_csv('data/test.csv', col_types = cols(
        PassengerId = col_integer(),
        Pclass = col_factor(levels = NULL),
        Name = col_character(),
        Sex = col_factor(levels = NULL),
        Age = col_double(),
        SibSp = col_factor(levels = NULL),
        Parch = col_factor(levels = NULL),
        Ticket = col_character(),
        Fare = col_double(),
        Cabin = col_character(),
        Embarked = col_character()
))
```

### Determine Predictors  

Which fields are present in both datasets?  

```{r}
combined_data <- submission_df %>% 
        mutate(IsTrain = FALSE) %>%
        bind_rows(mutate(labeled_df, IsTrain = TRUE))

combined_data %>%
        group_by(IsTrain) %>%
        summarise_all(~sum(is.na(.x)))
```

Select the non-missing features that would make sense as predictors

```{r}
predictors <- combined_data %>%
        select_if(~sum(is.na(.x)) == 0) %>%
        select(-PassengerId,-Name,-Ticket, -IsTrain) %>%
        names()

predictors
```

### Split training/holdout  

```{r}
set.seed(100)

train_index <- createDataPartition(labeled_df$Survived, p = 0.8, list = FALSE)

train_df <- labeled_df[train_index,]

holdout_df <- labeled_df[-train_index,]
```

### xgbTree model  

```{r}
set.seed(101)

ctrl <- trainControl(method = "repeatedcv",
                     classProbs = T,
                     summaryFunction = twoClassSummary,
                     number = 10, 
                     repeats = 5,
                     savePredictions = T)

xgbTree_train <- train(Survived ~ .,
                       data = train_df[,c('Survived',predictors)],
                       method = "xgbTree",
                       trControl = ctrl,
                       metric = 'ROC'
)
```

### Model summary  

```{r}
confusionMatrix(xgbTree_train)
```

